{% extends "dlf-base.html" %}
{%- set mainClasses = "govuk-main-wrapper--l" -%}

{% block head %}
{{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
{% endblock %}

{% block content %}


  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
         <div id="map-container"></div>
    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
    <script src="{{ static_path }}/static/javascripts/mhclg-maps.js"></script>
    <script src="{{ static_path }}/static/javascripts/leaflet-hover-effects.js"></script>

    <script>

        // initialise MHCLGMaps with mapbox access token
        const mhclgMaps = new MHCLGMaps({mapbox_token: '{{ config.MAPBOX_TOKEN }}'});

        const map = mhclgMaps.createMap("map-container");
        mhclgMaps.setMapContainerHeight(map, 3 / 2, true);

        map.setView(new L.LatLng(54.00366, -2.547855), 7);

        const planningAuthorityJson = {{ data | tojson }};

        function makeAndAddLayer(layerGroup) {
            const newLayer = new L.FeatureGroup();
            layerGroup.addLayer(newLayer);
            return newLayer;
        }

        var boundariesLayer = makeAndAddLayer(map);
        //var missingDataLayer = makeAndAddLayer(boundariesLayer);
        //var warningDataLayer = makeAndAddLayer(boundariesLayer);
        //var errorDataLayer = makeAndAddLayer(boundariesLayer);
        var validDataLayer = makeAndAddLayer(boundariesLayer);

        const disableStyle = {
            color: "#bfc1c3",
            fillColor: "#bfc1c3",
            fillOpacity: 0.3,
        };

        const validStyle = {
            color: "#006435",
            fillColor: "#006435",
            fillOpacity: 0.3,
        };

        const errorStyle = {
            color: "#b10e1e",
            fillColor: "#b10e1e",
            fillOpacity: 0.3,
        };

        const warningStyle = {
            color: "#ffbf47",
            fillColor: "#ffbf47",
            fillOpacity: 0.3,
        };

        var itemsProcessed = 0;

        function addLayerToABoundariesLayer(laBoundary, data, layerGroup, style) {
            laBoundary
                ._setDefaultStyles(style)
                ._addHoverHandlers();
            // speeds up page render by reducing js blocking time
            // might be quicker to do a timeout for each forEach call
            setTimeout(function () {
                itemsProcessed++;
                layerGroup.addLayer(laBoundary);
                setupPopup(laBoundary, data);
                if (itemsProcessed === planningAuthorityJson.length) {
                    orderBoundaryLayers();
                }
            }, 0);
        }

        planningAuthorityJson.forEach(function (planningAuthority) {
            if(planningAuthority.geojson){
                const boundary = L.geoJSON(planningAuthority.geojson);
                addLayerToABoundariesLayer(boundary, planningAuthority, validDataLayer, validStyle);
            }
        });

        function orderBoundaryLayers() {
            map.fitBounds(boundariesLayer.getBounds());
            validDataLayer.bringToFront();
        }

        const resultsTemplate =
            '<h3 class="govuk-heading-s">{planning_authority}</h3>' +
            '<ul class="govuk-list">' +
            '<li>{plan_count} plans</li>' +
            '</ul>' +
            '<p class="govuk-body"><a class="govuk-link" href="{url}">Go to local authority page</a></p>';

        function setupPopup(boundary, planningAuthority) {
            const url = `/planning-authority/` + planningAuthority.planning_authority
            const popupContent = L.Util.template(resultsTemplate,
                    {
                        planning_authority: planningAuthority.planning_authority,
                        plan_count: planningAuthority.plans.length,
                        url: url
                    });
                boundary.bindPopup(popupContent);
        }

    </script>
{% endblock %}


