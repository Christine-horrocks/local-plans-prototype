{% extends "dlf-base.html" %}

{% block beforeContent %}
 {{ super() }}

 {{ govukBreadcrumbs({
   "items": [
     {
       "text": "Planning Authority",
       "href": url_for("frontend.index")
     },
     {
       "text": planning_authority.name
     }
   ]
 }) }}

{% endblock %}

{% block content %}

  <span class="govuk-caption-l">Local plan data</span>
  <h1 class="govuk-heading-l">{{ planning_authority.name }}</h1>

  <h3 class="govuk-heading-m">Local plans</h3>

  <div class="govuk-tabs" data-module="tabs">
    <h2 class="govuk-tabs__title">
      Contents
    </h2>

    <ul class="govuk-tabs__list">
      {% for plan in plans %}
      <li class="govuk-tabs__list-item {% if plan.is_adopted() %}adopted-plan{% endif %}">
        <a class="govuk-tabs__tab govuk-tabs__tab--selected" href="#{{ plan.local_plan }}">
          {{ plan.local_plan }}
        </a>
      </li>
      {% endfor %}
    </ul>

    {% for plan in plans %}
    <section class="govuk-tabs__panel {% if plan.is_adopted() %}adopted-plan{% endif %}" id="{{ plan.local_plan }}">
      <h2 class="govuk-heading-l">{{ plan.local_plan }}</h2>

      <div class="pims-stages">

        {% set lastState = plan.ordered_states()|last %}
        <div class="current-stage">
          <span class="stage-tag">{{ lastState.state }}</span>
          <span class="stage-date">{{ lastState.date | format_month_and_year }}</span>
        </div>

        <details class="govuk-details">
          <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text">
             PINS Timeline
            </span>
          </summary>
          <div class="govuk-details__text">
            <table class="govuk-table">
              <tbody class="govuk-table__body">
                {% for state in plan.ordered_states() %}
                <tr class="govuk-table__row">
                  <th class="govuk-table__cell" scope="row">{{ state.state }}</th>
                  <td class="govuk-table__cell">{{ state.date | format_month_and_year }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>

      </div>

      <section class="lp-section-box lp-section-box__urls">
        <h3 class="govuk-heading-m">Local plan URLs</h3>
        <ul class="url-list">
          {% if plan.plan_documents|length > 0 %}
            {% for doc in plan.plan_documents %}
            <li class="url-item">
              <a class="url-link" href="{{ doc.url }}">{{ doc.url }}</a>
              <div class="url-item__controls">
                <a href="" class="url-item__btn url-edit-btn govuk-visually-hidden">Edit</a>
                <a href="{{ url_for('frontend.remove_document_from_plan', document_id=doc.id, local_plan=plan.local_plan) }}" class="url-item__btn url-remove-btn">Remove</a>
              </div>
            </li>
            {% endfor %}
          {% endif %}
        </ul>

        <form action="{{ url_for('frontend.add_document_to_plan', planning_authority=planning_authority.id, local_plan=plan.local_plan )}}" class="govuk-form url-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label label-add" for="url-input">
              Add URL to a local plan document
            </label>
            <label class="govuk-label label-edit" for="url-input">
              Edit URL to a local plan document
            </label>
            <input class="govuk-input" id="url-input" name="url-input" type="text">
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button url-save-btn">Save</button>
          </div>
        </form>

        <button class="govuk-button dlf-secondary-button url-add-btn">Add URL</button>
      </section>

      <section class="lp-section-box lp-section-box__notes">
        <h3 class="govuk-heading-m">Notes</h3>
        {% if plan.notes == None %}
        <p class="govuk-body note-contents"></p>
        <p class="govuk-body secondary-text">-- no notes captured --</p>
        {% else %}
        <p class="govuk-body note-contents">{{ plan.notes }}</p>
        {% endif %}
        <div class="edit">
          <button class="govuk-button dlf-secondary-button note-edit-btn">Edit<span class="govuk-visually-hidden">notes</span></button>
        </div>
        <form action="{{ url_for('frontend.add_document_to_plan', planning_authority=planning_authority.id, local_plan=plan.local_plan )}}" class="govuk-form note-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label" for="more-detail">
              Provide some information about the local plan
            </label>
            <textarea class="govuk-textarea" id="more-detail" name="more-detail" rows="5" aria-describedby="more-detail-hint"></textarea>
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button notes-save-btn">Save</button>
          </div>
        </form>
      </section>

      <section class="lp-section-box lp-section-box__number">
        <h3 class="govuk-heading-m">Number of housing units</h3>
        {% if plan.number_of_houses == None %}
        <p class="govuk-body number-contents"></p>
        <p class="govuk-body secondary-text">-- no number captured --</p>
        {% else %}
        <p class="govuk-body number-contents">{{ plan.number_of_houses }}</p>
        {% endif %}
        <p class="number-contents"></p>
        <form action="{{ url_for('frontend.add_document_to_plan', planning_authority=planning_authority.id, local_plan=plan.local_plan )}}" class="govuk-form number-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label" for="number-input">
              Homes to be built
            </label>
            <input class="govuk-input govuk-input--width-10" id="number-input" name="number-input" type="text">
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button number-save-btn">Save</button>
          </div>
        </form>
        
        <button class="govuk-button dlf-secondary-button number-edit-btn">Add number</button>
      </section>

    </section>
    {% endfor %}

  </div>
{% endblock %}

{% block bodyEnd %}
<script src="/static/javascripts/vendor/handlebars-v4.1.0.js"></script>
{% raw %}
<script id="url-item-template" type="text/x-handlebars-template">
    <a class="url-link" href="{{ url }}">{{ url }}</a>
    <div class="url-item__controls">
      <a href="" class="url-item__btn url-edit-btn govuk-visually-hidden">Edit</a>
      <a href="{{ remove_url }}" class="url-item__btn url-remove-btn">Remove</a>
    </div>
</script>
{% endraw %}
<script>
  const noteEditBtns = document.querySelectorAll(".note-edit-btn");
  const noteSaveBtns = document.querySelectorAll(".notes-save-btn");
  const numberEditBtns = document.querySelectorAll(".number-edit-btn");
  const numberSaveBtns = document.querySelectorAll(".number-save-btn");
  const urlAddBtns = document.querySelectorAll(".url-add-btn");
  const urlEditBtns = document.querySelectorAll(".url-edit-btn");
  const urlSaveBtns = document.querySelectorAll(".url-save-btn");
  const urlRemoveBtns = document.querySelectorAll(".url-remove-btn");

  var source   = document.getElementById("url-item-template").innerHTML;
  var urlTemplate = Handlebars.compile(source);

  noteEditBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      const noteSection = getNearestSection(e.currentTarget);
      noteSection.classList.add("editing");
      const note = noteSection.querySelector('.note-contents').textContent;
      if(note !== "") {
        noteSection.querySelector('textarea').value = note;
      }
    });
  });

  numberEditBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      const numberSection = getNearestSection(e.currentTarget);
      numberSection.classList.add("editing");
      const number = numberSection.querySelector('.number-contents').textContent;
      if(number !== "") {
        numberSection.querySelector('input[type=text]').value = number;
      } else {
        console.log("No number set");
      }
    });
  });

  function getNearestSection(el) {
    return el.closest(".lp-section-box");
  }

  function switchClasses(el, toAdd, toRemove) {
    el.classList.remove(toRemove);
    el.classList.add(toAdd);
  }

  function postDataFieldSaveEvent(btn, dataKey, inputSelector, callback) {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const form = e.currentTarget.closest("form");
      const url = form.getAttribute("action");
      const section = getNearestSection(e.currentTarget);

      // set up data obj to post
      var data = {};
      data[dataKey] = form.querySelector(inputSelector).value;

      // perform post
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then( (resp_data) => callback(resp_data, section) );
    });
  }

  urlAddBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      const current = e.currentTarget;
      const urlSection = getNearestSection(e.currentTarget);
      urlSection.classList.add('editing');
      urlSection.querySelector('.url-edit-form input[type=text]').value = "";
      const form = urlSection.querySelector('.url-edit-form');
      switchClasses(form, "adding", "editing");
    });
  });

  urlEditBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const urlSection = getNearestSection(e.currentTarget);
      const currentUrl = e.currentTarget.closest('.url-item').querySelector(".url-link").textContent;
      urlSection.classList.add('editing');
      urlSection.querySelector('.url-edit-form input[type=text]').value = currentUrl;
      const form = urlSection.querySelector('.url-edit-form');
      switchClasses(form, "editing", "adding");
    });
  });

  function removeURLBtnClickHandler(e) {
    e.preventDefault();
    const currentTarget = e.currentTarget;
    const url = e.currentTarget.href;
    fetch(url, {
      method: "DELETE"
    })
    .then(response => response.json())
    .then(data => {
      currentTarget.closest('.url-item').remove();
    });
  }

  urlRemoveBtns.forEach((btn) => {
    btn.addEventListener('click', removeURLBtnClickHandler);
  });

  urlSaveBtns.forEach((btn) => {
    postDataFieldSaveEvent(btn, "url", "input[type=text]", (data, section) => {
      const urlList = section.querySelector(".url-list")
      var item = document.createElement("li");
      item.classList.add('url-item');
      item.innerHTML = urlTemplate(data);
      urlList.appendChild( item );
      item.querySelector(".url-remove-btn").addEventListener('click', removeURLBtnClickHandler);
      section.querySelector("form input[type=text]").value = "";
    });
  });

  numberSaveBtns.forEach((btn) => {
    postDataFieldSaveEvent(btn, "housing_units", "input[type=text]", (data, section) => {
      const numberEl = section.querySelector(".number-contents")
      numberEl.textContent = data.housing_units;
      section.classList.remove("editing");
      if(section.querySelector('.secondary-text')) {
        section.querySelector('.secondary-text').remove();
      }
    });
  });

  noteSaveBtns.forEach((btn) => {
    postDataFieldSaveEvent(btn, "notes", "textarea", (data, section) => {
      const notesEl = section.querySelector(".note-contents")
      notesEl.textContent = data.notes;
      section.classList.remove("editing");
      if(section.querySelector('.secondary-text')) {
        section.querySelector('.secondary-text').remove();
      }
    });
  });

</script>
{% endblock %}
