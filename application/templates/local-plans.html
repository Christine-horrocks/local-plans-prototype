{% extends "dlf-base.html" %}

{% block beforeContent %}
 {{ super() }}

 {{ govukBreadcrumbs({
   "items": [
     {
       "text": "Planning Authority",
       "href": url_for("frontend.index")
     },
     {
       "text": planning_authority.name
     }
   ]
 }) }}

{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        {% for plan in plans %}
            <p>plan: {{ plan.local_plan }}: adopted: {{ plan.is_adopted() }}</p>
            <ul>
                {% for state in plan.ordered_states() %}
                    <li>{{ state.state }} {{ state.date | format_month_and_year }}</li>
                {% endfor %}
            </ul>
        {% endfor %}
    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">

  <span class="govuk-caption-l">Local plan data</span>
  <h1 class="govuk-heading-l">{{ planning_authority.name }}</h1>

  <h3 class="govuk-heading-m">Local plans with PIMS</h3>

  <div class="govuk-tabs" data-module="tabs">
    <h2 class="govuk-tabs__title">
      Contents
    </h2>

    <ul class="govuk-tabs__list">
      {% for plan in plans %}
      <li class="govuk-tabs__list-item">
        <a class="govuk-tabs__tab govuk-tabs__tab--selected" href="#{{ plan.local_plan }}">
          {{ plan.local_plan }}
        </a>
      </li>
      {% endfor %}
    </ul>

    {% for plan in plans %}
    <section class="govuk-tabs__panel" id="{{ plan.local_plan }}">
      <h2 class="govuk-heading-l">{{ plan.local_plan }}</h2>

      <div class="pims-stages">

        {% set lastState = plan.ordered_states()|last %}
        <div class="current-stage">
          <span class="stage-tag">{{ lastState.state }}</span>
          <span class="stage-date">{{ lastState.date }}</span>
        </div>

        <details class="govuk-details">
          <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text">
             PIMS Timeline
            </span>
          </summary>
          <div class="govuk-details__text">
            <table class="govuk-table">
              <tbody class="govuk-table__body">
                {% for state in plan.ordered_states() %}
                <tr class="govuk-table__row">
                  <th class="govuk-table__cell" scope="row">{{ state.state }}</th>
                  <td class="govuk-table__cell">{{ state.date }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>

      </div>

      <section class="lp-section-box lp-section-box__urls">
        <h3 class="govuk-heading-m">Local plan URLs</h3>
        <ul class="url-list">
          {% if plan.plan_documents|length > 0 %}
            {% for doc in plan.plan_documents %}
            <li class="url-item">
              <a class="url-link" href="{{ doc.url }}">{{ doc.url }}</a>
              <div class="url-item__controls">
                <a href="" class="url-item__btn url-edit-btn">Edit</a>
                <a href="" class="url-item__btn">Remove</a>
              </div>
            </li>
            {% endfor %}
          {% endif %}
        </ul>

        <form action="" class="govuk-form url-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label label-add" for="url-input">
              Add URL to a local plan document
            </label>
            <label class="govuk-label label-edit" for="url-input">
              Edit URL to a local plan document
            </label>
            <input class="govuk-input" id="url-input" name="url-input" type="text">
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button">Save</button>
          </div>
        </form>

        <button class="govuk-button dlf-secondary-button url-add-btn">Add URL</button>
      </section>

      <section class="lp-section-box lp-section-box__notes">
        <h3 class="govuk-heading-m">Notes</h3>
        <p class="govuk-body note-contents">{{ plan.notes }}</p>
        <div class="edit">
          <button class="govuk-button dlf-secondary-button note-edit-btn">Edit<span class="govuk-visually-hidden">notes</span></button>
        </div>
        <form action="" class="govuk-form note-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label" for="more-detail">
              Provide some information about the Local Plan
            </label>
            <span id="more-detail-hint" class="govuk-hint">
              Do this and this.....
            </span>
            <textarea class="govuk-textarea" id="more-detail" name="more-detail" rows="5" aria-describedby="more-detail-hint"></textarea>
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button">Save</button>
          </div>
        </form>
      </section>

      <section class="lp-section-box lp-section-box__number">
        <h3 class="govuk-heading-m">Number of houses</h3>
        <p class="number-contents"></p>
        <form action="" class="govuk-form number-edit-form">
          <div class="govuk-form-group">
            <label class="govuk-label" for="number-input">
              Homes to be built
            </label>
            <input class="govuk-input govuk-input--width-10" id="number-input" name="number-input" type="text">
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button">Save</button>
          </div>
        </form>
        
        <button class="govuk-button dlf-secondary-button number-edit-btn">Add number</button>
      </section>

    </section>
    {% endfor %}

  </div>
{% endblock %}

{% block bodyEnd %}
<script>
  const noteEditBtn = document.querySelector(".note-edit-btn");
  const numberEditBtn = document.querySelector(".number-edit-btn");
  const urlAddBtn = document.querySelector(".url-add-btn");
  const urlEditBtns = document.querySelectorAll(".url-edit-btn");

  noteEditBtn.addEventListener('click', (e) => {
    const noteSection = getNearestSection(e.currentTarget);
    noteSection.classList.add("editing");
    const note = noteSection.querySelector('.note-contents').textContent;
    if(note !== "") {
      noteSection.querySelector('textarea').value = note;
    }
    console.log(note);
  });

  numberEditBtn.addEventListener('click', (e) => {
    const numberSection = getNearestSection(e.currentTarget);
    numberSection.classList.add("editing");
    const number = numberSection.querySelector('.number-contents').textContent;
    if(number !== "") {
      numberSection.querySelector('input[type=text]').value = number;
    } else {
      console.log("No number set");
    }
  });

  function getNearestSection(el) {
    return el.closest(".lp-section-box");
  }

  function switchClasses(el, toAdd, toRemove) {
    el.classList.remove(toRemove);
    el.classList.add(toAdd);
  }

  urlAddBtn.addEventListener('click', (e) => {
    const current = e.currentTarget;
    const urlSection = getNearestSection(e.currentTarget);
    urlSection.classList.add('editing');
    urlSection.querySelector('.url-edit-form input[type=text]').value = "";
    const form = urlSection.querySelector('.url-edit-form');
    switchClasses(form, "adding", "editing");
  });

  urlEditBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const urlSection = getNearestSection(e.currentTarget);
      const currentUrl = e.currentTarget.closest('.url-item').querySelector(".url-link").textContent;
      urlSection.classList.add('editing');
      urlSection.querySelector('.url-edit-form input[type=text]').value = currentUrl;
      const form = urlSection.querySelector('.url-edit-form');
      switchClasses(form, "editing", "adding");
    });
  });
</script>
{% endblock %}
