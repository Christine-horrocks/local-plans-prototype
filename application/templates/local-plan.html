{% extends "dlf-base.html" %}
{% from "govuk-jinja-components/warning-text/macro.jinja" import govukWarningText %}
{% from "dl-macros/date-input.html" import renderDateInput %}

{% block beforeContent %}
 {{ super() }}

 {{ govukBreadcrumbs({
   "items": [
    {
       "text": "Home",
       "href": url_for("frontend.index")
     },
     {
       "text": "Planning Authority",
       "href": url_for("frontend.list_all")
     },
     {
       "text": planning_authority.name
     }
   ]
 }) }}

{% endblock %}

{% block content %}

  <span class="govuk-caption-xl">Local plan data</span>
  <h1 class="govuk-heading-xl">{{ planning_authority.name }}</h1>

{#  <div class="govuk-grid-row">#}
{#    <div class="govuk-grid-column-two-thirds">#}
{#      <h2 class="govuk-heading-l">Local development scheme</h2>#}
{#      <p class="govuk-body">#}
{#        Each planning authority is expected to publish a local development scheme. For {{ planning_authority.name }} you should be able to view it at:#}
{#      </p>#}
{#    </div>#}
{#  </div>#}
{#  #}
{#  {% if planning_authority.local_scheme_url %}#}
{##}
{#      <!--#}
{#      TODO we need to be able to add documents to this as well. in the same was as we add docs to plans#}
{#      except these are stored against local authority but in table emerging_plan_documents#}
{#      -->#}
{##}
{#      <p class="govuk-body">#}
{#        <a id="policy-url" class="govuk-link" href="{{ planning_authority.local_scheme_url }}">{{ planning_authority.local_scheme_url }}</a>#}
{#      </p>#}
{#      <p class="request-for-update govuk-!-margin-bottom-8">Not correct? <a href="{{ url_for('frontend.update_local_scheme_url', planning_authority=planning_authority.id) }}" class="govuk-link">Update the url</a>.</p>#}
{##}
{#      <h3 class="govuk-heading-m">Local scheme documents</h3>#}
{#        <ul class="url-list" data-url-list-type="lds-url-list">#}
{#          {% if planning_authority.other_documents|length > 0 %}#}
{#            {% for doc in planning_authority.other_documents %}#}
{#            <li class="url-item govuk-grid-row">#}
{#              <section class="document-link govuk-grid-column-full">#}
{#                {% if doc.title %}#}
{#                <span>{{ doc.title }}</span>#}
{#                {% else %}#}
{#                <span class="no-title-given">no title given</span>#}
{#                {% endif %}#}
{#                <a class="url-link" href="{{ doc.url }}" target="_blank">{{ doc.url }}</a>#}
{#                <div class="url-item__controls">#}
{#                  <a href="" class="url-item__btn url-edit-btn govuk-visually-hidden">Edit</a>#}
{#                  <a href="{{ url_for('frontend.remove_document_from_planning_authority', document=doc.id, planning_authority=planning_authority.id ) }}" class="url-item__btn url-remove-btn">Remove</a>#}
{#                </div>#}
{#              </section>#}
{##}
{#              <section class="document-facts govuk-clearfix">#}
{##}
{#                <div class="govuk-grid-column-full">#}
{#                <!-- TODO need some facts for emerging plan docs -->#}
{#                  <table class="govuk-table document-facts__table">#}
{#                    {% if doc.facts|length > 0 %}<caption class="govuk-table__caption">Facts from document</caption>{% endif %}#}
{#                    <tbody class="govuk-table__body">#}
{#                    {% for fact in doc.facts %}#}
{#                      <tr class="govuk-table__row">#}
{#                        <th class="govuk-table__header" scope="row">{% if fact.from_ and fact.to  %}{{ fact.from_ }} to {{fact.to }}{% else %}{{ fact.fact }}{%  endif %}</th>#}
{#                        <td class="govuk-table__cell">{{ fact.fact_type | format_fact }}</td>#}
{#                        <td class="govuk-table__cell">{% if fact.notes == "" %}-{% else %}{{ fact.notes }}{% endif %}</td>#}
{#                        <td class="govuk-table__cell">{% if fact.image_url %}<a href="{{ fact.image_url }}" target="_blank"><img style="height: 60px" src="{{ fact.image_url }}"></a>{% endif %}</td>#}
{#                        <td class="govuk-table__cell govuk-table__cell--numeric"><a class="remove-fact" href="{{ url_for('frontend.remove_fact_from_document', document=doc.id, fact=fact.id) }}">remove<span class="govuk-visually-hidden"> this fact</span></a></td>#}
{#                      </tr>#}
{#                    {% endfor %}#}
{#                    </tbody>#}
{#                  </table>#}
{#                </div>#}
{##}
{#                <details class="govuk-details govuk-details--facts govuk-details--facts-emerging-plan-doc govuk-grid-column-two-thirds">#}
{#                  <summary class="govuk-details__summary">#}
{#                    <span class="govuk-details__summary-text document-facts__add">#}
{#                      Add fact from document#}
{#                    </span>#}
{#                  </summary>#}
{##}
{#                  {% from "partials/emerging-plan-fact-form.html" import renderEmergingPlanFactForm %}#}
{##}
{#                  {{ renderEmergingPlanFactForm({#}
{#                      "action_url": url_for('frontend.add_fact_to_document', planning_authority=planning_authority.id, document=doc.id),#}
{#                      "fact_types": emerging_fact_types,#}
{#                      "form_number": loop.index#}
{#                    }) }}#}
{##}
{#                </details>#}
{##}
{#              </section>#}
{#            </li>#}
{#            {% endfor %}#}
{#          {% endif %}#}
{#        </ul>#}
{##}
{#      <form action="{{ url_for('frontend.add_document_to_plan', planning_authority=planning_authority.id,  document_type='emerging_plan_document' )}}" data-associated-list="lds-url-list" class="govuk-form add-url-form">#}
{#        <div class="govuk-form-group">#}
{#          <label class="govuk-label label-add" for="url-input">#}
{#          Add URL to a local development scheme or emerging plan document#}
{#          </label>#}
{#          <input class="govuk-input" id="url-input" name="url-input" type="text">#}
{#        </div>#}
{#        <div class="govuk-form-group">#}
{#          <label class="govuk-label" for="doc-title-input">#}
{#            Does the document have a title?#}
{#          </label>#}
{#          <input class="govuk-input govuk-input--width-20" id="doc-title-input" name="doc-title-input" type="text">#}
{#        </div>#}
{#        <div class="govuk-form-group">#}
{#          <button class="govuk-button dlf-secondary-button url-save-btn">Add URL</button>#}
{#        </div>#}
{#      </form>#}
{##}
{#  {% else %}#}
{#      <a class="highlight-box highlight-box--gap highlight-box--flush" href="{{ url_for('frontend.update_local_scheme_url', planning_authority=planning_authority.id) }}">#}
{#        <h3 class="govuk-heading-s highlight-box__title">URL unavailable</h3>#}
{#        <p class="govuk-body govuk-!-margin-bottom-0">We do not have a link to the local development scheme. Can you add one?</p>#}
{#      </a>#}
{#  {% endif %}#}

  <h2 class="govuk-heading-l govuk-!-margin-top-9">Local plans</h2>

  <div class="govuk-tabs" data-module="tabs">
    <h2 class="govuk-tabs__title">
      Contents
    </h2>

    <ul class="govuk-tabs__list">
      {% for plan in planning_authority.sorted_plans()  %}
      <li class="govuk-tabs__list-item {% if plan.is_adopted() %}adopted-plan{% endif %}">
        <a class="govuk-tabs__tab govuk-tabs__tab--selected" href="#plan_tab_{{ loop.index }}">
          {{ plan.title }}
        </a>
      </li>
      {% endfor %}
      <li class="govuk-tabs__list-item">
        <a href="#new-plan-tab" class="govuk-tabs__tab govuk-tabs__tab--add-new">Add new plan</a>
      </li>
    </ul>

    {% from "govuk-jinja-components/govuk-form/govuk-label.jinja" import govukLabel %}
    {% from "govuk-jinja-components/govuk-form/govuk-input.jinja" import govukTextInput %}

    {% macro renderPlanPeriodForm(plan, heading, suffix, classes) %}
    <form class="govuk-form{{- ' ' + classes if classes}}" action="{{ url_for('frontend.update_plan_period', planning_authority=planning_authority.id, plan_id=plan.id) }}" data-plan-id="{{ plan.id }}" method="POST">
      <h3 class="govuk-heading-s">{{ heading }}</h3>
      <div class="govuk-form-group">
        {{ govukLabel({ "label": "Start year", "for": "start_year_" + suffix }) }}
        {{ govukTextInput({
          "classes": "govuk-input govuk-date-input__year govuk-date-input__input govuk-input--width-4",
          "id": "start-year_" + suffix,
          "name": "start-year_" + suffix,
          "value": plan.plan_start_year | format_year
        }) }}
      </div>
      <div class="govuk-form-group">
        {{ govukLabel({ "label": "End year", "for": "end_year_" + suffix }) }}
        {{ govukTextInput({
          "classes": "govuk-input govuk-date-input__year govuk-date-input__input govuk-input--width-4",
          "id": "end-year_" + suffix,
          "name": "end-year_" + suffix,
          "value": plan.plan_end_year | format_year,
          "pattern":"[0-9]*"
        }) }}
      </div>
      <div class="govuk-form-group">
        <input type="submit" class="govuk-button dlf-secondary-button" value="Save plan period">
        <button class="cancel-btn">Cancel</button>
      </div>
    </form>
    {% endmacro %}

    {% for plan in planning_authority.sorted_plans() %}
    <section class="govuk-tabs__panel local-plan {% if plan.is_adopted() %}adopted-plan{% endif %}" id="plan_tab_{{ loop.index }}">
      <h2 class="govuk-heading-l editable-plan-title" data-update-plan-url="{{ url_for('frontend.update_plan', planning_authority=planning_authority.id, local_plan=plan.id) }}">
          {{ plan.title }}
      </h2>
        <h3 class="govuk-heading-m">Plan period</h3>
        {% if plan.plan_start_year is defined and plan.plan_start_year != None %}
        <div class="edit-plan-period">
          <p><span data-year-type="start">{{ plan.plan_start_year | format_year }}</span>-<span data-year-type="end">{{ plan.plan_end_year | format_year}}</span></p>
          <p class="request-for-update govuk-!-margin-bottom-8">Not correct? <a href="#" class="govuk-link">Update plan period</a>.</p>
          {{ renderPlanPeriodForm(plan, "Edit plan period", "edit" + loop.index | string) }}
        </div>
        {% else %}
        <div class="highlight-box highlight-box--gap highlight-box--flush missing-plan-period">
          <h3 class="govuk-heading-s highlight-box__title">Plan period unknown</h3>
          <p class="govuk-body govuk-!-margin-bottom-0">We do not have the plan period for this plan. Can you add it?</p>
          {{ renderPlanPeriodForm(plan, "Add plan period", "add" + loop.index | string, "govuk-form--contained") }}
        </div>
        {% endif %}

       {% if plan.url %}
          <h3 class="govuk-heading-m">Planning policy url</h3>
          <p class="govuk-body">
            <a id="policy-url" class="govuk-link" href="{{ plan.url }}" target="_blank">{{ plan.url }}</a>
          </p>
          <p class="request-for-update govuk-!-margin-bottom-8">Not correct? <a href="{{ url_for('frontend.update_local_plan_url', planning_authority=planning_authority.id, local_plan=plan.id) }}" class="govuk-link">Update the url</a>.</p>
          {% else %}
          <a class="highlight-box highlight-box--gap highlight-box--flush" href="{{ url_for('frontend.update_local_plan_url', planning_authority=planning_authority.id, local_plan=plan.id) }}">
            <h3 class="govuk-heading-s highlight-box__title">URL unavailable</h3>
            <p class="govuk-body govuk-!-margin-bottom-0">We do not have a link to the local plan. Can you add one?</p>
          </a>
       {% endif %}

     {% if not plan.is_emerging() %}
        <div class="pims-stages">
            {% set latest_state = plan.latest_state() %}
            <div class="current-stage">
                <span class="stage-tag">{{ latest_state.state }}</span>
                <span class="stage-date">{{ latest_state.date | format_month_and_year }}</span>
            </div>
            <details class="govuk-details">
                <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text">
                 PINS Timeline
                </span>
                </summary>
                <div class="govuk-details__text">
                    <table class="govuk-table">
                        <tbody class="govuk-table__body">
                        {% for state in plan.ordered_states() %}
                            <tr class="govuk-table__row">
                                <th class="govuk-table__cell" scope="row">{{ state.state }}</th>
                                <td class="govuk-table__cell">{{ state.date | format_month_and_year }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
    {% endif %}

      
        <h3 class="govuk-heading-m">Local plan documents</h3>
        <ul class="url-list" data-url-list-type="{{ plan.id }}-url-list">
          {% if plan.plan_documents|length > 0 %}
            {% for doc in plan.plan_documents %}
            <li class="url-item govuk-grid-row">
              <section class="document-link govuk-grid-column-full">
                {% if doc.title %}
                <span>{{ doc.title }}</span>
                {% endif %}
                <a class="url-link" href="{{ doc.url }}" target="_blank">{{ doc.url }}</a>
                <div class="url-item__controls">
                  <a href="" class="url-item__btn url-edit-btn govuk-visually-hidden">Edit</a>
                  <a href="{{ url_for('frontend.remove_document_from_plan', document=doc.id, local_plan=plan.id) }}" class="url-item__btn url-remove-btn">Remove</a>
                </div>
              </section>

              <section class="document-facts govuk-clearfix">

                <div class="govuk-grid-column-full">
                  <table class="govuk-table document-facts__table">
                    {% if doc.facts|length > 0 %}<caption class="govuk-table__caption">Facts from document</caption>{% endif %}
                    <tbody class="govuk-table__body">
                        {% for fact in doc.facts %}
                            <tr class="govuk-table__row" data-fact-type="{{ fact.fact_type }}">
                              <th class="govuk-table__header" scope="row">{% if fact.from_ and fact.to  %}{{ fact.from_ }} to {{fact.to }}{% else %}{{ fact.fact }}{%  endif %}</th>
                              <td class="govuk-table__cell">{{ fact.fact_type | format_fact }}</td>
                              <td class="govuk-table__cell">{% if fact.notes == "" %}-{% else %}{{ fact.notes }}{% endif %}</td>
                              <td class="govuk-table__cell">
                                {% if fact.image_url -%}
                                  <a href="{{ fact.image_url }}" target="_blank">
                                    <img style="height: 60px" src="{{ fact.image_url }}">
                                  </a>
                                {% endif -%}</td>
                              <td class="govuk-table__cell govuk-table__cell--numeric"><a class="remove-fact" href="{{ url_for('frontend.remove_fact_from_document', document=doc.id, fact=fact.id) }}">remove<span class="govuk-visually-hidden"> this fact</span></a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                  </table>
                </div>

                <details class="govuk-details govuk-details--facts govuk-details--facts-plan-doc govuk-grid-column-two-thirds">
                  <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text document-facts__add">
                      Add housing number from document
                    </span>
                  </summary>

                  {% from "partials/local-plan-fact-form.html" import renderLocalPlanFactForm %}

                  {{ renderLocalPlanFactForm({
                      "action_url": url_for('frontend.add_fact_to_document', planning_authority=planning_authority.id, local_plan=plan.id, document=doc.id),
                      "fact_types": fact_types,
                      "form_number": loop.index
                    }) }}

                </details>
                
              </section>
            </li>
            {% endfor %}
          {% endif %}
        </ul>

        <form action="{{ url_for('frontend.add_document_to_plan', planning_authority=planning_authority.id, local_plan=plan.id, document_type='plan_document' )}}" data-associated-list="{{ plan.id }}-url-list" class="govuk-form add-url-form">
          <div class="govuk-form-group">
            <label class="govuk-label" for="url-input">
              Add URL of document to local plan
            </label>
            <input class="govuk-input" id="url-input" name="url-input" type="text">
          </div>
          <div class="govuk-form-group">
            <label class="govuk-label" for="doc-title-input">
              Does the document have a title?
            </label>
            <input class="govuk-input govuk-input--width-20" id="doc-title-input" name="doc-title-input" type="text">
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button dlf-secondary-button url-save-btn">Add URL</button>
          </div>
        </form>

    </section>
    {% endfor %}
    <section id="new-plan-tab" class="govuk-tabs__panel">
      <h3 class="govuk-heading-m">Add a local plan</h3>
      <form class="govuk-form new-plan-form" method="post" action="{{ url_for('frontend.local_plan', planning_authority=planning_authority.id) }}">

          <div class="govuk-form-group">
              {{ form.title.label(class="govuk-label govuk-!-font-weight-bold") }}
              <span class="govuk-error-message">
            {% for error in form.title.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </span>
              {{ form.title(class="govuk-input") }}
          </div>

          <div class="govuk-form-group">
          {{ form.start_year.label(class="govuk-label govuk-!-font-weight-bold") }}
          <span class="govuk-error-message">
            {% for error in form.start_year.errors  %}
                <span>{{ error }}</span>
            {% endfor %}
          </span>
          {{ form.start_year(class="govuk-input govuk-date-input__year govuk-date-input__input govuk-input--width-4", pattern="[0-9]*") }}
         </div>
          <div class="govuk-form-group">
              {{ form.end_year.label(class="govuk-label govuk-!-font-weight-bold") }}
              <span class="govuk-error-message">
            {% for error in form.end_year.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </span>
              {{ form.end_year(class="govuk-input govuk-date-input__year govuk-date-input__input govuk-input--width-4", pattern="[0-9]*") }}
          </div>
          <div class="govuk-form-group">
            <button class="govuk-button dlf-secondary-button">Add plan</button>
          </div>

         {{ form.csrf_token }}
      </form>
    </section>

  </div>
{% endblock %}

{% block bodyEnd %}
<div class="govuk-visually-hidden emerging-plan-details-template">
  {% include "partials/emerging-plan-details.html" ignore missing %}
</div>

<div class="govuk-visually-hidden local-plan-details-template">
  {% include "partials/local-plan-details.html" ignore missing %}
</div>

<script src="/static/javascripts/vendor/handlebars-v4.1.0.js"></script>
{% raw %}
<script id="url-item-template" type="text/x-handlebars-template">
  <section class="document-link govuk-grid-column-full">
    <span class="document-title"></span>   
    <a class="url-link" href="{{ url }}">{{ url }}</a>
    <div class="url-item__controls">
      <a href="" class="url-item__btn url-edit-btn govuk-visually-hidden">Edit</a>
      <a href="{{ remove_url }}" class="url-item__btn url-remove-btn">Remove</a>
    </div>
  </section>
  <section class="document-facts govuk-clearfix">
    <div class="govuk-grid-column-full">
      <table class="govuk-table document-facts__table">
        <tbody class="govuk-table__body"></tbody>
      </table>
    </div>
  </section>
</script>
<script id="fact-row-template" type="text/x-handlebars-template">
  <th class="govuk-table__header" scope="row">{{ fact.fact }}</th>
  <td class="govuk-table__cell">{{ fact.fact_type_display }}</td>
  <td class="govuk-table__cell">{{#if fact.notes }}{{ fact.notes }}{{else}}-{{/if}}</td>
  <td class="govuk-table__cell"></td>
  <td class="govuk-table__cell govuk-table__cell--numeric"><a class="remove-fact" href="{{ remove_url }}">remove<span class="govuk-visually-hidden"> this fact</span></a></td>
</script>
{% endraw %}

<script src="{{ static_path }}/static/javascripts/dlf/helpers.js"></script>
<script>
  const urlAddBtns = document.querySelectorAll(".url-add-btn");
  const urlEditBtns = document.querySelectorAll(".url-edit-btn");
  const urlRemoveBtns = document.querySelectorAll(".url-remove-btn");

  const addUrlForms = document.querySelectorAll(".add-url-form");

  const factSaveBtns = document.querySelectorAll(".fact-save-btn");
  const factCancelBtns = document.querySelectorAll(".add-fact-form .cancel-btn");
  const factTables = document.querySelectorAll(".document-facts__table");

  var source   = document.getElementById("url-item-template").innerHTML;
  var urlTemplate = Handlebars.compile(source);

  var factTemplateSource = document.getElementById("fact-row-template").innerHTML;
  var factTemplate = Handlebars.compile(factTemplateSource);

  // handle changes to form when user changes select
  const addFactForms = document.querySelectorAll(".add-fact-form");
  const addFactDetails = Array.prototype.slice.call( addFactForms ).map((form) => form.closest("details"));
  addFactDetails.forEach((detail) => {
    const summary = detail.querySelector("summary");
    summary.addEventListener('click', (e) => {
      const form = detail.querySelector("form");
      const firstFormGroup = form.querySelectorAll(".govuk-form-group")[0];
      if(!detail.open) {
        const option = firstFormGroup.querySelector('option:checked');
        indicateIfFactAlreadySet(option, form);
      }
    });
  });
  const addFactSelects = Array.prototype.slice.call( addFactForms ).map((form) => form.querySelector(".fact-select-types"));
  addFactSelects.forEach((select) => {
    select.addEventListener('change', (e) => {
      const form = e.target.closest('form');
      const option = e.target.querySelector('option:checked');

      indicateIfFactAlreadySet(option, form);

      // remove all these classes before adding selected class
      removeAllClassesFromFactForm(form);
      form.classList.add(option.dataset.typeClass);
    });
  });

  function checkIfFactIsSet(fact_type, form) {
    const table = form.closest(".document-facts").querySelector(".document-facts__table");
    const fact = table.querySelectorAll(`[data-fact-type=${fact_type}]`);
    return (fact.length > 0) ? true:false;
  }

  function indicateIfFactAlreadySet(option, form) {
    const formGroup = option.closest(".govuk-form-group");

    formGroup.classList.remove('fact-already-set');
    if(checkIfFactIsSet(option.value, form)) {
      formGroup.classList.add('fact-already-set');
    }
  }

  const localPlanFactTypeClasses = ["housing-requirement-total", "housing-requirement-range", "housing-requirement-yearly-average", "housing-requirement-yearly-range"];
  const emergingPlanFactTypeClasses = ["publication-date", "proposed-reg-18-date", "proposed-publication-date", "proposed-submission-date", "proposed-main-modifications-date", "proposed-adoption-date" ];
  // using the spread operator in prototype
  // in prod need to either change or use Babel
  const allFactTypeClasses = [...localPlanFactTypeClasses, ...emergingPlanFactTypeClasses];

  function removeAllClassesFromFactForm(form) {
    form.classList.remove( ...allFactTypeClasses );
  }

  function extractDate(fieldset) {
    const month = fieldset.querySelector(".govuk-date-input__month");
    const year = fieldset.querySelector(".govuk-date-input__year");
    if(month) {
      return `${year.value},${month.value}`;
    }
    return `${year.value}`;
  }

  function extractRange(fieldset) {
    var min = cleanNumber( fieldset.querySelector("[data-range-type='start']").value );
    var max = cleanNumber( fieldset.querySelector("[data-range-type='end']").value );
    return `${min},${max}`;
  }

  // save a fact
  // ===========
  factSaveBtns.forEach((btn) => {
    btn.addEventListener('click', factSubmitHandler);
  });

  function factSubmitHandler(e) {
    e.preventDefault();
    const form = e.target.closest("form");
    const url = form.getAttribute("action");

    // set up data obj to post
    // serialise all parts of form
    var fact = {};
    fact["fact_type"] = form.querySelector("select").value;
    fact["notes"] = form.querySelector("textarea").value;
    fact["document_type"] = form.querySelector("input[type='hidden']").value;

    if (form.classList.contains('housing-requirement-total')) {
      fact["fact"] = cleanNumber( form.querySelector(".plan-housing-req-total input").value );
    } else if (form.classList.contains('housing-requirement-range')) {
      fact["fact"] = extractRange( form.querySelector(".housing-req-range-fieldset") );
    } else if (form.classList.contains('housing-requirement-yearly-average')) {
      fact["fact"] = cleanNumber( form.querySelector(".housing-req-yearly-average-input input").value );
    } else if (form.classList.contains('housing-requirement-yearly-range')) {
      fact["fact"] = extractRange( form.querySelector(".housing-req-yearly-range-fieldset") );
    } else if (form.classList.contains('publication-date')) {
      fact["fact"] = extractDate( form.querySelector(".publication-date-input fieldset") );
    } else if (form.classList.contains('proposed-reg-18-date')) {
      fact["fact"] = extractDate( form.querySelector(".regulation-18-date-input fieldset") );
    } else if (form.classList.contains('proposed-publication-date')) {
      fact["fact"] = extractDate( form.querySelector(".proposed-publication-date-input fieldset") );
    } else if (form.classList.contains('proposed-submission-date')) {
      fact["fact"] = extractDate( form.querySelector(".proposed-submission-date-input fieldset") );
    } else if (form.classList.contains('proposed-main-modifications-date')) {
      fact["fact"] = extractDate( form.querySelector(".proposed-main-modifications-date-input fieldset") );
    } else if (form.classList.contains('proposed-adoption-date')) {
      fact["fact"] = extractDate( form.querySelector(".proposed-adoption-date-input fieldset") );
    } else {
      // situation where user has selected other
      fact["fact"] = "";
    }
    
    // if serialising
    // fact["plan_name"] = form.querySelector(".plan-name-input input").value;
    // fact["plan_start_date"] = extractDate( form.querySelector(".plan-start-date-input fieldset") );
    // fact["plan_end_date"] = extractDate( form.querySelector(".plan-end-date-input fieldset") );
    // fact["housing_req_total"] = form.querySelector(".plan-housing-req-total input").value;
    // fact["housing_req_range_min"] = form.querySelector(".housing-req-range-fieldset .housing-req-range-min").value;
    // fact["housing_req_range_max"] = form.querySelector(".housing-req-range-fieldset .housing-req-range-max").value;
    
    console.log(fact);

    // perform post
    postJSONRequest(url, {'fact': fact}, (resp_data) => factAddedCallback(resp_data, form));
  }

  function factAddedCallback(resp_data, form) {
    if(resp_data['OK'] === 200) {
      const factsEl = form.closest(".document-facts");
      const table = factsEl.querySelector(".document-facts__table tbody");

      const row = createElementWithClasses("tr", "govuk-table__row");
      row.dataset.factType = resp_data.fact["fact_type"];
      row.innerHTML = factTemplate(resp_data);
      table.appendChild( row );

      resetFactForm(form);
    }
  }

  // resets the form
  // - deletes any added content
  // - sets form to initial display config
  function resetFactForm(form) {
    form.reset();
    const formType = form.querySelector("input[type='hidden']").value;

    // remove all classes
    removeAllClassesFromFactForm(form);
    // add initial class relevant to type of fact
    if(formType === "plan_document") {
      form.classList.add('plan-name');
    } else {
      form.classList.add('publication-date');
    }
  }

  // close fact form
  // ===============
  factCancelBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const form = btn.closest('.govuk-form');
      resetFactForm(form);
      const details = btn.closest('.govuk-details');
      //console.log(details);
      details.open = false;
    })
  });

  // remove fact
  // ===========
  factTables.forEach((table) => {
    table.addEventListener('click', (e) => {
      e.preventDefault();
      if(e.target.classList.contains("remove-fact")) {
        console.log("Delete button clicked");
        removeBtnClickHandler(e, '.govuk-table__row')
      }
    });
  });

  function removeBtnClickHandler(e, selector) {
    e.preventDefault();
    const elementToBeRemoved = e.target.closest(selector);

    const url = e.target.href;
    fetch(url, {
      method: "DELETE"
    })
    .then(response => response.json())
    .then(data => {
      // element needs to have a tranistion in it's css
      // brittle!
      elementToBeRemoved.addEventListener('transitionend', () => elementToBeRemoved.remove());
      elementToBeRemoved.classList.add("being-deleted");
    });
  }

  urlRemoveBtns.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      removeBtnClickHandler(e, '.url-item');
    });
  });

  addUrlForms.forEach((form) => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const input = form.querySelector("input[name='url-input']");

      if(input.value === "") {
        alert("The URL field is empty. Please add a URL before saving.")
      } else {
        const urlList = document.querySelector(`[data-url-list-type='${form.dataset.associatedList}']`);
        saveURL(form.action, form, urlList);
      }
      console.log(e);
    });
  });

  function saveURL(endpoint, form, listEl) {
    // set up data obj
    var data = {
      'url': form.querySelector("input[name='url-input']").value,
      'doc_title': form.querySelector("input[name='doc-title-input']").value
    };

    // perform post
    postJSONRequest(endpoint, data, (resp_data) => handleSaveURLResponse(resp_data, listEl));
  }

  function handleSaveURLResponse(resp_data, listElement) {
    console.log(resp_data);
    const item = createElementWithClasses("li", ['url-item', 'govuk-grid-row']);
    item.innerHTML = urlTemplate(resp_data);
    const detailsContainer = item.querySelector(".document-facts");
    const detailsEl = cloneAddFactForm(resp_data.document['type'], resp_data.add_fact_url);
    detailsContainer.appendChild( detailsEl );

    // add title to URL template
    if(resp_data.document['title'] !== "") {
      item.querySelector(".document-title").textContent = resp_data.document['title'];
    }

    listElement.appendChild( item );

    // add submit handler
    const formBtn = detailsEl.querySelector('form .fact-save-btn');
    formBtn.addEventListener('click', factSubmitHandler);

    // hook up remove button
    item.querySelector(".url-remove-btn").addEventListener('click', (e) => {
      e.preventDefault();
      removeBtnClickHandler(e, '.url-item')
    });
  }

  function cloneAddFactForm(docType, add_fact_url) {
    let template;
    if(docType === "plan_document") {
      template = document.querySelector(".local-plan-details-template");
    } else {
      template = document.querySelector(".emerging-plan-details-template");
    }
    const detailsElement = template.querySelector('details');
    const clonedFormContainer = detailsElement.cloneNode(true);
    // update the action attribute
    const form = clonedFormContainer.querySelector('form');
    form.action = add_fact_url;

    return clonedFormContainer;
  };


  // ------------
  // make plan titles editable
  // -------------
  const planTitles = document.querySelectorAll(".editable-plan-title");
  planTitles.forEach(makeTitleEditable);

  function createEditableUI(currentValue) {

    const container = createElementWithClasses("div", "editable-title__container");
    const form = createElementWithClasses("form", "form--inline");

    const input = createElementWithClasses("input", ["govuk-input"]);
    const inputContainer = createElementWithClasses("div", "govuk-form-group");
    inputContainer.appendChild(input);

    input.setAttribute("type", "text");
    input.value = currentValue.trim();
    input.dataset.currentSavedValue = currentValue.trim();
    input.addEventListener('focus', (e) => {
      container.classList.remove("has-error");
    });

    const saveBtn = createElementWithClasses("button", "govuk-button");
    saveBtn.textContent = "Save";

    const cancelButton = createElementWithClasses("button", "cancel-btn");
    cancelButton.textContent = "Cancel";

    const buttonContainer = createElementWithClasses("div", "govuk-form-group");
    buttonContainer.appendChild(saveBtn);
    buttonContainer.appendChild(cancelButton);

    const errorMessage = createElementWithClasses("div", "error-msg");
    errorMessage.textContent = "Plan with this title already exists";

    form.appendChild(inputContainer);
    form.appendChild(buttonContainer);
    form.appendChild(errorMessage);
    container.appendChild(form);

    return container;
  }

  function getExitEditModeHandler(container) {
    return function() {
      container.classList.remove("edit-mode");
    } 
  }

  function makeTitleEditable(titleEl) {
    const localPlanEl = titleEl.closest(".local-plan");
    const editTitleEndpoint = titleEl.dataset.updatePlanUrl;

    const planTitleContainer = createElementWithClasses("div", "plan-title__container");
    wrapElement( titleEl, planTitleContainer );
    
    const editableUI = createEditableUI(titleEl.textContent);
    insertAfter(editableUI, titleEl);

    planTitleContainer.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    titleEl.addEventListener('click', function(e) {
      planTitleContainer.classList.toggle("edit-mode");
      document.addEventListener('click', clickOffEditTitle);
      document.addEventListener('keydown', clickOffEditTitle);
    });

    const exitEditModeHandler = getExitEditModeHandler( planTitleContainer );

    function clickOffEditTitle(e) {
      // only exit edit mode if user clicks off or presses escape key
      if( (e.type === "keydown" && e.keyCode === 27) | e.type === "click") {
        console.log("switched off by click or esc");
        exitEditModeHandler();
        document.removeEventListener('click', clickOffEditTitle);
        document.removeEventListener('keydown', clickOffEditTitle);
      }
    }

    function updateWithNewPlanTitle(newTitle) {
      // update plan-title
      titleEl.textContent = newTitle;
      // update tab label
      const tab = document.querySelector(`#tab_${localPlanEl.id}`);
      tab.textContent = newTitle;
      // remove edit-mode class
      planTitleContainer.classList.remove("edit-mode");
      // update edit input data attribute
      editableUI.querySelector("input").dataset.currentSavedValue = newTitle;
    }

    const form = editableUI.querySelector("form");
    const input = editableUI.querySelector("input");
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const original = input.dataset.currentSavedValue;
      const newTitle = input.value;
      postJSONRequest(editTitleEndpoint,
        {'original_identifier': original,
         'new_identifier': newTitle
        },
        (resp_data) => {
          console.log(resp_data);
          if(resp_data['OK'] == 200) {
            updateWithNewPlanTitle(newTitle);
          } else {
            editableUI.classList.add("has-error");
          }
        }
      );
    });
  }

  // -----------------------
  // handle plan period form
  // -----------------------
  const ppFormContainers = document.querySelectorAll(".missing-plan-period");

  ppFormContainers.forEach((ppFormContainer) => {

    function openHighlightBox(e) {
      if(!ppFormContainer.classList.contains("active")) {
        ppFormContainer.classList.add("active");
        ppFormContainer.removeEventListener("click", openHighlightBox)
      }
    }
    ppFormContainer.addEventListener("click", openHighlightBox);

    const ppForm = ppFormContainer.querySelector("form");
    console.log(ppForm);
    const ppFormCancel = ppForm.querySelector(".cancel-btn");

    ppFormCancel.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      ppFormContainer.classList.remove("active");
      ppFormContainer.addEventListener("click", openHighlightBox);
    });

    ppForm.addEventListener("submit", (e) => {
      console.log("trying to submit...");
      e.preventDefault();

      const endpoint = ppForm.action;

      const data = {
        "start-year": ppForm.querySelector("[name^='start_year']").value,
        "end-year": ppForm.querySelector("[name^='end_year']").value
      };

      postJSONRequest(endpoint, data, function(respData) {
        // To Do: handle the response
        console.log(respData);
      });
    });

  });

  // -------------------------
  // make plan period editable
  // -------------------------
  function EditableSection(section, opts) {
    this.section = section;
    this.options = opts || {};

    this.enterEditMode = () => this.section.classList.add("edit-mode");
    this.exitEditMode = () => this.section.classList.remove("edit-mode");

    if (this.options.trigger) {
      this.setEditTrigger(this.options.trigger);
    } else {
      this.setEditTrigger();
    }

  }

  EditableSection.prototype.setEditTrigger = function(selector) {
    if (selector) {
      this.trigger = this.section.querySelector(selector);
    } else {
      this.trigger = this.section.querySelector(".request-for-update a");
    }
    this.addEditListener();

    if (this.options.cancel) {
      this.setCancelTrigger(this.options.cancel);
    } else {
      this.setCancelTrigger();
    }
  }

  EditableSection.prototype.addEditListener = function() {
    const that = this;
    function editHandler(e) {
      e.preventDefault();
      that.enterEditMode();
    }
    this.trigger.addEventListener("click", editHandler);
  }

  EditableSection.prototype.setCancelTrigger = function(selector) {
    if (selector) {
      this.cancel = this.section.querySelector(selector);
      //this.trigger.addEventListener("click", )
    } else {
      this.cancel = this.section.querySelector(".cancel-btn");
    }
    this.addCancelListener();
  }

  EditableSection.prototype.addCancelListener = function() {
    const that = this;
    function cancelHandler(e) {
      e.preventDefault();
      that.exitEditMode();
    }
    this.cancel.addEventListener("click", cancelHandler);
  }

  EditableSection.prototype.initialiseForm = function(extractDataFunc, succCb, errCb) {
    const form = this.section.querySelector("form");
    this.form = form;

    const that = this;
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const endpoint = form.action;

      const data = extractDataFunc(form);

      postJSONRequest(endpoint, data, function(respData) {
        // To Do: handle the response
        if(respData["OK"] === 200) {
          that.exitEditMode();
          succCb(respData);
        }
        console.log(respData);
      });
    });
  }

  const planPeriods = document.querySelectorAll(".edit-plan-period");
  planPeriods.forEach((plan) => {
    const editableSection = new EditableSection(plan);
    const extractData = (form) => {
      return data = {
        "start-year": form.querySelector("[name^='start-year']").value,
        "end-year": form.querySelector("[name^='end-year']").value
      };
    };
    const onSuccessfulChange = (data) => {
      const startyear = editableSection.section.querySelector("[data-year-type='start']");
      const endyear = editableSection.section.querySelector("[data-year-type='end']");
      startyear.textContent = data.plan.plan_start_year;
      endyear.textContent = data.plan.plan_end_year;
    }

    editableSection.initialiseForm(extractData, onSuccessfulChange);
  });

</script>
{% endblock %}
